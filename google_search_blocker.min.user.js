// ==UserScript==
// @name         Google Search Blocker
// @namespace    https://github.com/shosatojp/google_search_blocker/raw/master
// @homepage     https://github.com/shosatojp/google_search_blocker
// @version      0.11.2.3
// @description  Block undesired sites from google search results!
// @author       Sho Sato
// @match        https://www.google.com/search?*
// @match        https://www.google.co.jp/search?*
// @match        https://www.bing.com/search?*
// @match        https://search.yahoo.co.jp/*
// @resource     form         ./form.html?
// @resource     modal        ./modal.html?
// @resource     buttons      ./buttons.html?
// @resource     selectors    ./selectors.html?
// @resource     environments ./environments.json?
// @resource     languages    ./languages.json?
// @updateURL    ./google_search_blocker.user.js?
// @downloadURL  ./google_search_blocker.user.js?
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_getResourceText
// @run-at       document-start
// @noframes
// ==/UserScript==
!function(){"use strict";console.log(`%cGoogle Search Blocker ${GM_info.script.version}`,"color:lightseagreen;font-size:large;"),console.log("%cCopyright Â© 2019 Sho Sato. All Rights Reserved.","color:lightseagreen;");const Element_prototype_appendChild=Element.prototype.appendChild,Element_prototype_insertBefore=Element.prototype.insertBefore,Colors={Red:"#F44336",Pink:"#E91E63",Purple:"#9C27B0",Deeppurple:"#673AB7",Indigo:"#3F51B5",Blue:"#2196F3",LightBlue:"#03A9F4",Cyan:"#00BCD4",Teal:"#009688",Green:"#4CAF50",LightGreen:"#8BC34A",Lime:"#CDDC39",Yellow:"#FFEB3B",Amber:"#FFC107",Orange:"#FF9800",DeepOrange:"#FF5722",Brown:"#795548",Gray:"#9E9E9E",BlueGray:"#607D8B"},DriveSync=function(){const DriveSync=function(client_id,filename,setModifiedTime,getModifiedTime,defaultOnDownload,defaultGetData,usesync,setUseSync,onsignin,onsignout){this.CLIENT_ID=client_id,this.FILE_NAME=filename,this.setModifiedTime=setModifiedTime,this.getModifiedTime=getModifiedTime,this.defaultOnDownload=defaultOnDownload,this.defaultGetData=defaultGetData,this.usesync=usesync,this.setUseSync=setUseSync,this.onsignin=onsignin,this.onsignout=onsignout};return DriveSync.prototype.request=async function(e){return await gapi.client.request(e)},DriveSync.prototype.authenticate=function(){return gapi.auth2.getAuthInstance().signIn({scope:"https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file",prompt:"select_account"})},DriveSync.prototype.createFile=async function(name){return(await this.request({path:"/drive/v3/files",method:"POST",body:{name:name}})).result},DriveSync.prototype.findFile=async function(name){return(await this.request({path:"/drive/v3/files",method:"GET",params:{q:`name = '${name}' and trashed = false`,fields:"files(id, modifiedTime)"}})).result.files[0]},DriveSync.prototype.updateFileContent=async function(id,content){await this.request({path:`/upload/drive/v3/files/${id}`,method:"PATCH",params:{uploadType:"media"},body:content})},DriveSync.prototype.getFileContent=async function(id){return(await this.request({path:`/drive/v3/files/${id}`,method:"GET",params:{alt:"media"}})).body},DriveSync.prototype.compare=async function(onDownload,getData){var file;if(onDownload=onDownload||this.defaultOnDownload,getData=getData||this.defaultGetData,(file=await this.findFile(this.FILE_NAME))||(file=await this.createFile(this.FILE_NAME))){const serverModifiedTime=new Date(file.modifiedTime).getTime(),localModifiedTime=this.getModifiedTime();console.log("server:",serverModifiedTime,serverModifiedTime===localModifiedTime?"=":serverModifiedTime>localModifiedTime?">":"<","local:",localModifiedTime),localModifiedTime<serverModifiedTime?(onDownload(await this.getFileContent(file.id),serverModifiedTime),this.setModifiedTime(serverModifiedTime)):localModifiedTime>serverModifiedTime?(await this.updateFileContent(file.id,getData()),this.setModifiedTime(Date.now()),this.setModifiedTime(new Date((await this.findFile(this.FILE_NAME)).modifiedTime).getTime())):console.log("nothing to do.")}else console.error("%ccannot sync file",`color:${Colors.Red};`)},DriveSync.prototype.marge=function(){},DriveSync.prototype.pull=function(){},DriveSync.prototype.push=async function(){var file;(file=await this.findFile(this.FILE_NAME))||(file=await this.createFile(this.FILE_NAME))?(await this.updateFileContent(file.id,this.defaultGetData()),this.setModifiedTime(Date.now()),this.setModifiedTime(new Date((await this.findFile(this.FILE_NAME)).modifiedTime).getTime())):console.error("%ccannot sync file",`color:${Colors.Red};`)},DriveSync.prototype.signIn=function(){return new Promise((res,rej)=>{gapi.auth2.getAuthInstance().isSignedIn.get()?(console.log("%calready signed in",`color:${Colors.Green};`),this.onsignin(),res()):this.authenticate().then(()=>{console.log("%csigned in",`color:${Colors.Green};`),this.onsignin(),res()},()=>{console.log("%csigned in failed",`color:${Colors.Green};`),this.onsignout(),rej()})})},DriveSync.prototype.initSync=function(){const self=this;return new Promise((res,rej)=>{if(this.usesync())if("gapi"in window)self.signIn().then(res,rej);else{const script=document.createElement("script");script.setAttribute("src","https://apis.google.com/js/api.js"),document.body.appendChild(script),script.addEventListener("load",()=>{gapi.load("client:auth2",async function(){gapi.auth2.init({client_id:CLIENT_ID}).then(()=>{self.signIn().then(res,rej)}).catch(e=>{console.log(e),rej()})})}),script.addEventListener("error",function(){rej()})}else rej()})},DriveSync.prototype.signOut=function(){gapi.auth2.getAuthInstance().signOut(),this.onsignout(),console.log("%csigned out",`color:${Colors.Green};`)},DriveSync}(),R={form:void 0,button_showlist:void 0,count:void 0,button_reblock:void 0,button_show:void 0,button_hidelist:void 0,button_complete:void 0,button_edit:void 0,contents:void 0,textarea_domains:void 0,blocked:void 0,info:void 0,result_container:void 0,signin:void 0,signout:void 0,syncinfo:void 0,modal:void 0},LANGUAGE=window.navigator.languages&&window.navigator.languages[0]||window.navigator.language||window.navigator.userLanguage||window.navigator.browserLanguage,LOCAL_STRING=JSON.parse(GM_getResourceText("languages")).filter(x=>~x.language.indexOf(LANGUAGE.toLowerCase())||~x.language.indexOf("en"))[0].ui,TextResource=function(){const TextResource={},_resource={};return TextResource.get=function(name){if(!(name in _resource)){let src=GM_getResourceText(name),obj=JSON.parse(GM_getResourceText("languages")).filter(x=>~x.language.indexOf(LANGUAGE.toLowerCase())||~x.language.indexOf("en"))[0].ui;for(const key in obj)obj.hasOwnProperty(key)&&(src=src.replace("${"+key+"}",obj[key]));_resource[name]=src}return _resource[name]},TextResource}(),Patterns=function(){const Patterns={get:function(){return GM_getValue("url","").split(";").filter(e=>e)},set:function(domains){GM_setValue("url",domains.join(";"))},add:function(pattern){const list_=Patterns.get();pattern&&!~list_.indexOf(pattern)&&list_.push(pattern),Patterns.set(list_)},remove:function(pattern){let list_,newlist_=Patterns.get().filter(e=>e!=pattern);Patterns.set(newlist_)}};return Patterns}(),Util=function(){const Util={distinct:function distinct(list,f=(e=>e)){var temp_=list.map(x=>f(x));return list.filter((value,index,self)=>temp_.indexOf(f(value))===index)},orderBy:function(list,...fn){return list.sort((a,b)=>{for(let i=0,len=fn.length;i<len;i++){const f=fn[i];var aa=f(a),bb=f(b);if(aa>bb)return 1;if(bb>aa)return-1}return 0})},regex_escape:function(n){return n.replace(/([.?*+^$&[\]\\(){}|<>-])/g,"\\$1")},getCandidate:function(url){let c=new URL(url),result=[];var split,temp=(split=c.host.split(".").reverse()).shift();result.push({regex:temp,alias:temp}),split.forEach(e=>{temp=e+"."+temp,result.push({regex:temp,alias:temp})}),result.shift();const exclude=["co.jp","ne.jp"];result=result.filter(e=>!~exclude.indexOf(e.regex));var split=c.pathname.substr(1).split("/").filter(e=>e),temp="#https?://"+Util.regex_escape(c.host),temp_alias=c.host;return split.pop(),split.slice(0,2).forEach(e=>{temp+="/"+Util.regex_escape(e),temp_alias+="/"+e,result.push({regex:temp,alias:temp_alias})}),result},isMobileDevice:function(){return navigator.userAgent.match(/(Android|webOS|iPhone|iPad|iPod|BlackBerry|Windows Phone)/i)},getUrlParams:function(url){const result={};return new URL(url).search.substring(1).split("&").forEach(e=>{const pair=e.split("=");2===pair.length&&(result[pair[0]]=pair[1].length?pair[1]:null)}),result}};return Util}(),Controller=function(){const Controller=function(parent,target_url){this.parent=parent,this.target_url=target_url,this.open_button_=void 0,this.close_button_=void 0};return Controller.prototype.createButton=function(){if(!this.parent.querySelector(".google_search_block_buttons_form")){const container_=document.createElement("div");container_.className="google_search_block_buttons_form",container_.innerHTML=TextResource.get("buttons"),this.open_button_=container_.querySelector(".google_search_block_button_openui"),this.close_button_=container_.querySelector(".google_search_block_button_closeui"),this.open_button_.addEventListener("click",this.openButton.bind(this)),this.close_button_.addEventListener("click",this.closeButton.bind(this)),this.parent.appendChild(container_)}},Controller.prototype.openButton=function(){this.create(),this.open_button_.style.display="none",this.close_button_.style.display="block",SETTINGS.result_box_style_class&&this.parent.classList.add(SETTINGS.result_box_style_class)},Controller.prototype.closeButton=function(){this.open_button_.style.display="block",this.close_button_.style.display="none",this.parent.querySelector(".google_search_block_blockui").remove(),SETTINGS.result_box_style_class&&this.parent.classList.remove(SETTINGS.result_box_style_class)},Controller.prototype.create=function(){const self=this,class_name="google_search_block_blockui_container";let old_=self.parent.querySelector("."+class_name);old_&&old_.remove();const div=document.createElement("div");div.className=class_name,div.innerHTML=TextResource.get("selectors");const contents_=div.querySelector(".google_search_block_blockui_contents");Util.getCandidate(self.target_url).forEach(e=>{const code=document.createElement("code");code.textContent=e.alias;const span=document.createElement("span");span.className="google_search_block_button",span.setAttribute("url",e.regex),span.addEventListener("click",function(){Patterns.add(this.getAttribute("url")),BLOCK=Patterns.get(),div.remove(),SETTINGS.result_box_style_class&&self.parent.classList.remove(SETTINGS.result_box_style_class),GoogleSearchBlock.all(),self.open_button_.style.display="block",self.close_button_.style.display="none",SYNC.initSync().then(()=>SYNC.push()).catch(()=>{SYNC.setModifiedTime(Date.now())})}),span.appendChild(code),contents_.appendChild(span)}),self.parent.appendChild(div)},Controller}(),GoogleSearchBlock=function(){const GoogleSearchBlock={};let blocked_patterns_=[],time=0;return GoogleSearchBlock.one=function(e){const start_=performance.now(),link_=e.querySelector(SETTINGS.second);let removed_=!1;if(link_){e.style["background-color"]="";const url_=link_.getAttribute("href");if(!url_.startsWith("http"))return;const host_=new URL(url_).host;for(let i=0,len=BLOCK.length;i<len;i++){const block_pattern_=BLOCK[i];if("#"===block_pattern_.charAt(0)?url_.match(new RegExp(block_pattern_.substr(1),"g")):host_.endsWith(block_pattern_)){e.style.display="none",e.style["background-color"]="rgba(248, 195, 199, 0.884)",removed_=block_pattern_,~blocked_patterns_.indexOf(block_pattern_)||(blocked_patterns_.push(block_pattern_),R.blocked&&GoogleSearchBlock.createButton(block_pattern_)),COUNT++,R.count&&(R.count.textContent=COUNT),console.log("one",COUNT);break}}removed_||(e.style.display="block"),new Controller(e,url_).createButton()}return time+=performance.now()-start_,removed_},GoogleSearchBlock.all=function(aggregate=!0){const start_=performance.now();let count_=0;blocked_patterns_=[],COUNT=0,document.querySelectorAll(SETTINGS.first).forEach(e=>{GoogleSearchBlock.one(e)&&count_++}),COUNT=count_,console.log("all",count_),time=performance.now()-start_,aggregate&&GoogleSearchBlock.aggregate()},GoogleSearchBlock.aggregate=function(){for(;R.blocked.firstChild;)R.blocked.removeChild(R.blocked.firstChild);Util.distinct(blocked_patterns_).sort().forEach(e=>{GoogleSearchBlock.createButton(e)}),R.count.textContent=COUNT,R.textarea_domains.value=Patterns.get().sort().join("\n"),R.info.textContent=`${Math.floor(10*time)/10}ms ${BLOCK.length}`},GoogleSearchBlock.createButton=function(pattern){const code=document.createElement("code");code.textContent=pattern;const span=document.createElement("span");span.className="google_search_block_button",span.setAttribute("domain",pattern),span.addEventListener("click",function(){var domain=this.getAttribute("domain");Patterns.remove(domain),BLOCK=Patterns.get(),GoogleSearchBlock.all(),SYNC.initSync().then(()=>SYNC.push()).catch(()=>{SYNC.setModifiedTime(Date.now())})}),span.appendChild(code),R.blocked.appendChild(span)},GoogleSearchBlock}();function initializeForm(container){const e=document.createElement("div");e.innerHTML=TextResource.get("form"),container.appendChild(e),R.form=document.querySelector("#google_search_block"),Object.assign(R,{button_showlist:R.form.querySelector("#google_search_block_button_showlist"),count:R.form.querySelector("#google_search_block_count"),button_reblock:R.form.querySelector("#google_search_block_button_reblock"),button_show:R.form.querySelector("#google_search_block_button_show"),button_hidelist:R.form.querySelector("#google_search_block_button_hidelist"),button_complete:R.form.querySelector("#google_search_block_button_complete"),button_edit:R.form.querySelector("#google_search_block_button_edit"),contents:R.form.querySelector("#google_search_block_contents"),textarea_domains:R.form.querySelector("#google_search_block_textarea_domains"),blocked:R.form.querySelector("#google_search_block_blocked"),info:R.form.querySelector("#google_search_block_info"),signin:R.form.querySelector("#google_search_block_button_signin"),signout:R.form.querySelector("#google_search_block_button_signout"),syncinfo:R.form.querySelector("#google_search_block_button_syncinfo"),modal:R.form.querySelector("#google_search_block_modal")}),R.form.classList.add(...SETTINGS.container_class.split(" ")),R.button_complete.addEventListener("click",function(){R.textarea_domains.disabled=!0,R.textarea_domains.style.overflow="hidden";const list_=Util.distinct(R.textarea_domains.value.split("\n").map(e=>e.trim()).filter(e=>e));Patterns.set(list_),BLOCK=list_,GoogleSearchBlock.all(),SYNC.initSync().then(()=>SYNC.push()).catch(()=>{SYNC.setModifiedTime(Date.now())})}),R.button_edit.addEventListener("click",function(){R.textarea_domains.disabled=!1,R.textarea_domains.style.overflow="unset"}),R.button_show.addEventListener("click",function(){document.querySelectorAll(SETTINGS.first).forEach(e=>e.style.display="block"),R.button_reblock.style.display="block",R.button_show.style.display="none"}),R.button_reblock.addEventListener("click",function(){GoogleSearchBlock.all(),R.button_reblock.style.display="none",R.button_show.style.display="block"}),R.button_hidelist.addEventListener("click",function(){R.button_showlist.style.display="block",R.button_hidelist.style.display="none",R.contents.style.display="none"}),R.button_showlist.addEventListener("click",function(){R.button_showlist.style.display="none",R.button_hidelist.style.display="block",R.contents.style.display="block",R.textarea_domains.value=Patterns.get().sort().join("\n")}),R.signin.addEventListener("click",function(){R.syncinfo.textContent="",SYNC.setUseSync(!0),SYNC.initSync().then(()=>{SYNC.compare()}).catch(()=>{R.syncinfo.textContent=LOCAL_STRING.failedtosync,SYNC.setUseSync(!1)})}),R.signout.addEventListener("click",function(){R.syncinfo.textContent="",SYNC.setUseSync(!1),SYNC.signOut()}),R.modal.addEventListener("change",function(){Modal.set(this.checked),location.reload()}),R.modal.checked=Modal.get(),R.textarea_domains.disabled=!0}const Modal=function(){const Modal={init:function(){document.body.insertAdjacentHTML("beforeEnd",TextResource.get("modal")),Modal.button_open=document.querySelector("#google_search_block_modal_button_open"),Modal.button_close=document.querySelector("#google_search_block_modal_button_close"),Modal.container=document.querySelector("#google_search_block_modal_container"),Modal.button_open.addEventListener("click",function(){Modal.button_close.style.display="block",Modal.button_open.style.display="none",Modal.container.style.display="flex"}),Modal.button_close.addEventListener("click",function(){Modal.button_open.style.display="block",Modal.button_close.style.display="none",Modal.container.style.display="none"})},getContainer:function(){return Modal.container},set:function(bool){GM_setValue("modal",(+bool).toString())},get:function(){return!!parseInt(GM_getValue("modal","0"))}};return Modal}();function getObserverFunction(){const walkAddedNodesInRecords=function(compare){return function(classname){return function(records,callback){for(const record of records)for(const node of record.addedNodes)compare(node,classname)&&callback(node)}}},observer_functions={containsInClassListWhenAdded:walkAddedNodesInRecords((node,classname)=>node instanceof Element&&node.classList.contains(classname)),equalsClassNameWhenAdded:walkAddedNodesInRecords((node,classname)=>node instanceof Element&&node.className===classname)};return observer_functions[SETTINGS.observer_function](...SETTINGS.observer_fn_arguments)}function init(){let environment_=null;{const isMobile_=Util.isMobileDevice();if("www.google.com"===location.host||"www.google.co.jp"===location.host){if(Util.getUrlParams(location.href).tbm)return void console.warn("this page is not a search result page.");environment_=isMobile_?"google_mobile":"google_pc"}else"www.bing.com"===location.host?environment_=isMobile_?"bing_mobile":"bing_pc":"search.yahoo.co.jp"===location.host&&(environment_=isMobile_?"yahoo_co_jp_mobile":"yahoo_co_jp_pc");console.log("environment:",environment_)}if(!(SETTINGS=JSON.parse(TextResource.get("environments"))[environment_]))return void console.error("no settings");console.log(document.querySelectorAll(SETTINGS.first).length+" elements was found before start MutationObserver"),GoogleSearchBlock.all(!1);const mutation_processed_=[],onMutated=getObserverFunction(),observer_=new MutationObserver(function(records){onMutated(records,element=>{~mutation_processed_.indexOf(element)||(GoogleSearchBlock.one(element),mutation_processed_.push(element))})});observer_.observe(document.documentElement,{childList:!0,subtree:!0}),window.addEventListener("DOMContentLoaded",function(){if(console.log("%c----------DOMContentLoaded----------",`color:${Colors.LightBlue};`),R.result_container=document.querySelector(SETTINGS.result_container)){if(COUNT=0,Modal.get()?(Modal.init(),initializeForm(Modal.getContainer())):initializeForm(R.result_container),GoogleSearchBlock.all(),"mobile"===environment_){const observer_=new MutationObserver(function(records){records.filter(x=>"getAttribute"in x.target&&"insert"===x.target.getAttribute("data-graft-type")).length&&(COUNT=0,GoogleSearchBlock.all())});observer_.observe(document.querySelector(SETTINGS.observer_target),{attributes:!0,childList:!0,characterData:!0,attributeFilter:[],subtree:!0})}window.addEventListener("load",function(){console.log("%c----------------load----------------",`color:${Colors.LightGreen};`),Element.prototype.insertBefore=Element_prototype_insertBefore,Element.prototype.appendChild=Element_prototype_appendChild,(SYNC=new DriveSync(CLIENT_ID,LIST_FILE_NAME,time=>{GM_setValue("modified",time.toString())},()=>parseInt(GM_getValue("modified","0")),data=>{console.log("%cDOWNLOAD",`color:${Colors.Pink};`,data.split("\n").length),Patterns.set(data.split("\n")),BLOCK=Patterns.get(),GoogleSearchBlock.all()},()=>(console.log("%cUPLOAD",`color:${Colors.Blue};`,Patterns.get().length),Patterns.get().join("\n")),function usesync(){return!!parseInt(GM_getValue("usesync","0"))},function setusesync(bool){GM_setValue("usesync",(+bool).toString())},function onsignin(){R.signin.style.display="none",R.signout.style.display="block",R.syncinfo.textContent=gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile().getEmail()},function onsignout(){R.signin.style.display="block",R.signout.style.display="none"})).initSync().then(()=>SYNC.compare()).catch(()=>{})})}else console.error("result container not found.")})}const CLIENT_ID="531665009269-96fvecl3pj4717mj2e6if6oaph7eu8ar.apps.googleusercontent.com",LIST_FILE_NAME="GoogleSearchBlocker.txt";let COUNT=0,SETTINGS=null,SYNC=null,BLOCK=Util.distinct(Patterns.get());init()}();